<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Group Buying</title>
    <link rel="stylesheet" href="admin.css">
    <style>
        /* Auth-related styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        .header-content {
            flex: 1;
        }
        .btn-logout {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-logout:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body>
    <!-- Auth Check Script - runs immediately -->
    <script>
        (function() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            // Verify token format and expiration
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                if (!payload.exp || payload.exp <= Date.now() / 1000) {
                    localStorage.removeItem('adminToken');
                    window.location.href = 'login.html';
                }
            } catch (e) {
                localStorage.removeItem('adminToken');
                window.location.href = 'login.html';
            }
        })();
    </script>
    
    <div class="admin-container">
        <header>
            <div class="header-content">
                <h1>üéØ Drop Admin</h1>
                <p>Configure your group buying campaign</p>
            </div>
            <button type="button" class="btn-logout" onclick="logout()" title="Logout">
                üö™ Logout
            </button>
        </header>
        
        <!-- Campaign Selector -->
        <section class="form-section campaign-selector-section">
            <h2>üìÅ Campaign</h2>
            <div class="form-row">
                <div class="form-group three-quarters">
                    <label>Select Campaign</label>
                    <select id="campaign-selector" onchange="onCampaignSelect()">
                        <option value="">-- Select a campaign --</option>
                    </select>
                </div>
                <div class="form-group quarter">
                    <label>&nbsp;</label>
                    <button type="button" class="btn-secondary" onclick="createNewCampaign()">+ New Campaign</button>
                </div>
            </div>
            <div class="campaign-id-display" id="campaign-id-display" style="display: none;">
                <span class="label">Campaign ID:</span>
                <code id="current-campaign-id"></code>
                <span class="url-hint" id="campaign-url-hint"></span>
            </div>
        </section>
        
        <form id="admin-form" style="display: none;">
            <!-- Stats Section - AT THE TOP -->
            <section class="form-section stats">
                <h2>üìä Live Stats</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <span class="stat-label">Total Buyers</span>
                        <span class="stat-value" id="stat-total-buyers">-</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">Real Participants</span>
                        <span class="stat-value" id="stat-real">-</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">Current Price</span>
                        <span class="stat-value" id="stat-current-price">-</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">Time Left</span>
                        <span class="stat-value" id="stat-time-left">-</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">SMS Sent</span>
                        <span class="stat-value" id="stat-sms-sent">-</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">Expected Revenue</span>
                        <span class="stat-value" id="stat-expected-revenue">-</span>
                    </div>
                </div>
                <button type="button" class="btn-secondary" onclick="viewParticipants()">üë• View Participants</button>
                <button type="button" class="btn-secondary" onclick="downloadParticipants()" id="download-btn" style="margin-left: 10px;">üì• Download Excel</button>
            </section>
            
            <!-- Product Section -->
            <section class="form-section">
                <h2>üì¶ Product</h2>
                <div class="form-group">
                    <label>Product Image URL</label>
                    <input type="url" id="product-image" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="product-name" placeholder="Product name">
                </div>
                <div class="form-group">
                    <label>Short Description (HTML supported)</label>
                    <textarea id="product-description" rows="5" placeholder="e.g., <h4>Product Details</h4><p>Description...</p>"></textarea>
                </div>
            </section>
            
            <!-- Video Section -->
            <section class="form-section">
                <h2>üé• Video</h2>
                <div class="form-group">
                    <label>m3u8 Video URL</label>
                    <input type="url" id="video-source" placeholder="https://.../playlist.m3u8">
                </div>
            </section>

            <!-- Checkout Section -->
            <section class="form-section">
                <h2>üõí Checkout</h2>
                <div class="form-group">
                    <label>Checkout URL</label>
                    <input type="url" id="checkout-url" placeholder="https://shop.example.com/product">
                    <small>Product purchase URL that buyers will be directed to</small>
                </div>
            </section>

            <!-- Terms & Conditions Section -->
            <section class="form-section">
                <h2>üìã Legal</h2>
                <div class="form-group">
                    <label>Terms & Conditions URL</label>
                    <input type="url" id="terms-url" placeholder="https://example.com/terms">
                    <small>Link to your Terms & Conditions page. Displayed on the landing page below the registration form.</small>
                </div>
            </section>

            <!-- Twilio SMS Section -->
            <section class="form-section">
                <h2>üì± Twilio SMS</h2>
                <div class="form-group checkbox">
                    <label>
                        <input type="checkbox" id="twilio-enabled">
                        Enable SMS notifications
                    </label>
                </div>
                <div class="form-group">
                    <label>Account SID</label>
                    <input type="text" id="twilio-sid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                </div>
                <div class="form-group">
                    <label>Auth Token</label>
                    <input type="password" id="twilio-token" placeholder="your_auth_token">
                </div>
                <div class="form-group">
                    <label>Twilio Phone Number</label>
                    <input type="text" id="twilio-number" placeholder="+1234567890">
                    <small>Must be a Twilio number with SMS capability</small>
                </div>
                <div class="form-group">
                    <label>Your Domain (for referral links)</label>
                    <input type="text" id="domain" placeholder="https://your-domain.com">
                    <small>Used in SMS messages for referral links</small>
                </div>
            </section>
            
            <!-- Pricing Section -->
            <section class="form-section">
                <h2>üí∞ Pricing</h2>
                <div class="form-row">
                    <div class="form-group half">
                        <label>Initial Price ($)</label>
                        <input type="number" id="initial-price" min="0" step="0.01">
                    </div>
                    <div class="form-group half">
                        <label>Initial Buyers Count</label>
                        <input type="number" id="initial-buyers" min="0">
                    </div>
                </div>
                
                <h3>Price Tiers</h3>
                <div class="tier-header">
                    <span class="tier-header-label">#</span>
                    <span class="tier-header-label">Buyers</span>
                    <span class="tier-header-label">Price ($)</span>
                    <span class="tier-header-label">Coupon Code</span>
                    <span class="tier-header-label">Actions</span>
                </div>
                <div id="price-tiers">
                    <!-- Dynamic tier rows -->
                </div>
                <button type="button" class="btn-secondary" onclick="addTier()">+ Add Tier</button>
            </section>
            
            <!-- Referral Section -->
            <section class="form-section">
                <h2>üéÅ Referral Rewards</h2>
                <div class="form-group">
                    <label>Referrals Needed to Unlock Best Price</label>
                    <input type="number" id="referrals-needed" min="1" max="10" value="2">
                    <small>How many friends must join for the referrer to instantly unlock the lowest price</small>
                </div>
            </section>
            
            <!-- Countdown Section -->
            <section class="form-section">
                <h2>‚è∞ Countdown</h2>
                <div class="form-group">
                    <label>End Date & Time</label>
                    <input type="datetime-local" id="countdown-end">
                    <small>Times are in your local timezone</small>
                </div>
            </section>
            
            <!-- Actions -->
            <div class="form-actions">
                <button type="submit" class="btn-primary">üíæ Save Changes</button>
                <button type="button" class="btn-secondary" onclick="resetForm()">‚Ü∫ Reset</button>
                <button type="button" class="btn-danger" onclick="deleteCampaign()">üóëÔ∏è Delete Campaign</button>
            </div>
        </form>
        
        <div id="no-campaign" style="display: none; text-align: center; padding: 40px;">
            <p style="color: #888; margin-bottom: 20px;">Select a campaign above or create a new one to get started.</p>
        </div>
        
        <div id="toast" class="toast"></div>
    </div>
    
    <!-- Participants Modal -->
    <div id="participants-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Participants</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <table id="participants-table">
                    <thead>
                        <tr>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Referral Code</th>
                            <th>Referred By</th>
                            <th>Campaign</th>
                            <th>Joined</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- SMS Flow Visualization Section -->
    <section class="form-section sms-flow-section">
        <h2>üì± SMS Flow Journey</h2>
        <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">Visual guide to all SMS messages and their triggers</p>
        
        <div class="sms-flow">
            <!-- Welcome SMS -->
            <div class="sms-flow-item">
                <div class="sms-flow-trigger">
                    <span class="trigger-badge trigger-join">üéØ User Joins</span>
                </div>
                <div class="sms-flow-arrow">‚¨á</div>
                <div class="sms-flow-card">
                    <div class="sms-flow-header">
                        <span class="sms-icon">üí¨</span>
                        <span class="sms-title">Welcome SMS</span>
                    </div>
                    <div class="sms-preview">
                        "You're in the drop! üéâ Share your link to unlock $X... Get N friends to join!"
                    </div>
                </div>
            </div>
            
            <!-- Reminder SMS -->
            <div class="sms-flow-item">
                <div class="sms-flow-trigger">
                    <span class="trigger-badge trigger-reminder">‚è∞ 2hrs Before End</span>
                </div>
                <div class="sms-flow-arrow">‚¨á</div>
                <div class="sms-flow-card">
                    <div class="sms-flow-header">
                        <span class="sms-icon">üö®</span>
                        <span class="sms-title">Reminder SMS</span>
                        <span class="sms-condition">(if not unlocked)</span>
                    </div>
                    <div class="sms-preview">
                        "üö® X buyers joined - Y left to unlock $Z, share your link!"
                    </div>
                </div>
            </div>
            
            <!-- Unlock SMS -->
            <div class="sms-flow-item">
                <div class="sms-flow-trigger">
                    <span class="trigger-badge trigger-unlock">üéâ Threshold Met</span>
                </div>
                <div class="sms-flow-arrow">‚¨á</div>
                <div class="sms-flow-card">
                    <div class="sms-flow-header">
                        <span class="sms-icon">üîì</span>
                        <span class="sms-title">Unlock SMS</span>
                    </div>
                    <div class="sms-preview">
                        "Congrats! You've unlocked $X! Use code CODE at checkout..."
                    </div>
                </div>
            </div>
            
            <!-- End-of-Drop SMS -->
            <div class="sms-flow-item">
                <div class="sms-flow-trigger">
                    <span class="trigger-badge trigger-end">üèÅ Drop Ends</span>
                </div>
                <div class="sms-flow-arrow">‚¨á</div>
                <div class="sms-flow-card">
                    <div class="sms-flow-header">
                        <span class="sms-icon">üèÜ</span>
                        <span class="sms-title">End-of-Drop SMS</span>
                    </div>
                    <div class="sms-preview">
                        "End of the drop! You've unlocked $X. Use code CODE... - Valid 4 hours"
                    </div>
                </div>
            </div>
            
            <!-- Checkout -->
            <div class="sms-flow-item checkout-item">
                <div class="sms-flow-card checkout-card">
                    <div class="sms-flow-header">
                        <span class="sms-icon">üõí</span>
                        <span class="sms-title">Checkout</span>
                    </div>
                    <div class="sms-preview">
                        Customer completes purchase with unlocked price
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Opt-out/Opt-in Flow (Side branch) -->
        <div class="sms-subflow">
            <h3>üìã Subscription Management</h3>
            <div class="sms-subflow-grid">
                <div class="sms-flow-card">
                    <div class="sms-flow-header">
                        <span class="sms-icon">üö´</span>
                        <span class="sms-title">Opt-out Confirmation</span>
                    </div>
                    <div class="sms-preview">
                        <strong>Trigger:</strong> User replies "STOP"<br>
                        "You've been unsubscribed. Reply START to resubscribe."
                    </div>
                </div>
                <div class="sms-flow-card">
                    <div class="sms-flow-header">
                        <span class="sms-icon">‚úÖ</span>
                        <span class="sms-title">Opt-in Confirmation</span>
                    </div>
                    <div class="sms-preview">
                        <strong>Trigger:</strong> User replies "START"<br>
                        "You're subscribed! Welcome back."
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <style>
        .sms-flow-section {
            background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
            border: 2px solid #e9d5ff;
        }
        .sms-flow-section h2 {
            color: #7c3aed;
        }
        .sms-flow {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 30px;
        }
        .sms-flow-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .sms-flow-trigger {
            margin-bottom: 8px;
        }
        .trigger-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .trigger-join {
            background: #dbeafe;
            color: #1e40af;
        }
        .trigger-reminder {
            background: #fef3c7;
            color: #92400e;
        }
        .trigger-unlock {
            background: #d1fae5;
            color: #065f46;
        }
        .trigger-end {
            background: #fce7f3;
            color: #9d174d;
        }
        .sms-flow-arrow {
            color: #9ca3af;
            font-size: 20px;
            margin: 4px 0;
        }
        .sms-flow-card {
            background: #fff;
            border-radius: 12px;
            padding: 16px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #8b5cf6;
        }
        .checkout-card {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #fff 100%);
        }
        .sms-flow-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .sms-icon {
            font-size: 20px;
        }
        .sms-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 15px;
        }
        .sms-condition {
            font-size: 12px;
            color: #9ca3af;
            margin-left: auto;
        }
        .sms-preview {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            color: #4b5563;
            font-style: italic;
            line-height: 1.5;
        }
        .checkout-item {
            margin-top: 10px;
        }
        .sms-subflow {
            border-top: 2px dashed #d8b4fe;
            padding-top: 24px;
        }
        .sms-subflow h3 {
            color: #7c3aed;
            font-size: 14px;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .sms-subflow-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
        }
        .sms-subflow-grid .sms-flow-card {
            border-left-color: #6b7280;
        }
    </style>

    <script src="admin.js"></script>
</body>
</html>